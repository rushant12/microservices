package com.example.demo.service;

import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import com.azure.security.keyvault.secrets.models.KeyVaultSecret;
import com.azure.storage.blob.*;
import com.azure.storage.blob.models.BlobClient;
import com.azure.storage.blob.models.BlobContainerClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.io.File;

@Service
public class BlobStorageService {

    private static final Logger logger = LoggerFactory.getLogger(BlobStorageService.class);

    private final SecretClient secretClient;

    public BlobStorageService() {
        this.secretClient = new SecretClientBuilder()
                .vaultUrl("https://<your-key-vault-name>.vault.azure.net/") // Replace with your Key Vault URI
                .credential(new DefaultAzureCredentialBuilder().build())     // Uses Managed Identity
                .buildClient();
    }

    public String uploadFile(String filePath, String batchId) throws Exception {
        logger.info("Fetching secrets from Azure Key Vault...");

        // Fetch secrets from Key Vault
        String accountName = getSecretValue("accountName");
        String accountKey = getSecretValue("accountKey");
        String containerName = getSecretValue("containerName");

        logger.info("Fetched accountName={}, containerName={}", accountName, containerName);

        // Build the connection string
        String connectionString = String.format(
                "DefaultEndpointsProtocol=https;AccountName=%s;AccountKey=%s;EndpointSuffix=core.windows.net",
                accountName, accountKey
        );

        // Create Blob client
        BlobServiceClient blobServiceClient = new BlobServiceClientBuilder()
                .connectionString(connectionString)
                .buildClient();

        BlobContainerClient containerClient = blobServiceClient.getBlobContainerClient(containerName);
        if (!containerClient.exists()) {
            containerClient.create();
        }

        File file = new File(filePath);
        String blobName = batchId + "/" + file.getName();

        BlobClient blobClient = containerClient.getBlobClient(blobName);
        blobClient.uploadFromFile(file.getAbsolutePath(), true);

        String blobUrl = blobClient.getBlobUrl();
        logger.info("File uploaded to blob storage at URL: {}", blobUrl);

        return blobUrl;
    }

    private String getSecretValue(String secretName) {
        KeyVaultSecret secret = secretClient.getSecret(secretName);
        return secret.getValue();
    }
}
azure.keyvault.uri=https://<your-key-vault-name>.vault.azure.net/

logging.level.com.azure.spring=DEBUG
