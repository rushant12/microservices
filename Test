package com.nedbank.kafka.filemanage.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.http.HttpHost;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.UsernamePasswordCredentials;
import org.apache.http.impl.client.BasicCredentialsProvider;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.impl.conn.DefaultProxyRoutePlanner;
import org.springframework.http.*;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;

public class VaultClient {

    private static final String AUTH_URL = "https://vault-public-vault-75e984b5.bdecd756.z1.hashicorp.cloud:8200/v1/auth/userpass/login/espire_dev";
    private static final String SECRET_URL = "https://vault-public-vault-75e984b5.bdecd756.z1.hashicorp.cloud:8200/v1/Store_Dev/10099";
    private static final String NAMESPACE = "admin/espire";
    private static final String USER_PASSWORD = "Dev+Cred4#";

    // Use RestTemplate with proxy configuration
    private final RestTemplate restTemplate = createRestTemplateWithProxy();
    private final ObjectMapper mapper = new ObjectMapper();

    public String getSecretFromVault() {
        try {
            // 1. Authenticate and get token
            HttpHeaders authHeaders = new HttpHeaders();
            authHeaders.setContentType(MediaType.APPLICATION_JSON);
            authHeaders.set("x-vault-namespace", NAMESPACE);

            String authBody = "{\"password\": \"" + USER_PASSWORD + "\"}";
            HttpEntity<String> authRequest = new HttpEntity<>(authBody, authHeaders);

            ResponseEntity<String> authResponse = restTemplate.postForEntity(AUTH_URL, authRequest, String.class);
            if (!authResponse.getStatusCode().is2xxSuccessful()) {
                throw new RuntimeException("Failed to authenticate with Vault");
            }

            JsonNode authJson = mapper.readTree(authResponse.getBody());
            String token = authJson.at("/auth/client_token").asText();

            // 2. Read secret using token
            HttpHeaders readHeaders = new HttpHeaders();
            readHeaders.set("x-vault-namespace", NAMESPACE);
            readHeaders.set("x-vault-token", token);

            HttpEntity<Void> readRequest = new HttpEntity<>(readHeaders);
            ResponseEntity<String> readResponse = restTemplate.exchange(SECRET_URL, HttpMethod.GET, readRequest, String.class);

            if (!readResponse.getStatusCode().is2xxSuccessful()) {
                throw new RuntimeException("Failed to read secret from Vault");
            }

            return readResponse.getBody();

        } catch (Exception e) {
            throw new RuntimeException("Error while accessing Vault: " + e.getMessage(), e);
        }
    }

    public RestTemplate createRestTemplateWithProxy() {
        String proxyHost = "webproxy.africa.nedcor.net";
        int proxyPort = 9001;
        String proxyUser = "CC437236";
        String proxyPass = "34dYaB@jEh56";

        HttpHost proxy = new HttpHost(proxyHost, proxyPort);

        // Set proxy credentials
        BasicCredentialsProvider credsProvider = new BasicCredentialsProvider();
        credsProvider.setCredentials(
                new AuthScope(proxyHost, proxyPort),
                new UsernamePasswordCredentials(proxyUser, proxyPass)
        );

        DefaultProxyRoutePlanner routePlanner = new DefaultProxyRoutePlanner(proxy);

        CloseableHttpClient httpClient = HttpClients.custom()
                .setDefaultCredentialsProvider(credsProvider)
                .setRoutePlanner(routePlanner)
                .build();

        HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient);
        return new RestTemplate(factory);
    }

    public static void main(String[] args) {
        VaultClient vaultService = new VaultClient();
        String secret = vaultService.getSecretFromVault();
        System.out.println("Secret from Vault:\n" + secret);
    }
}
