package com.nedbank.kafka.filemanage.service;

import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.core.credential.TokenCredential;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import com.azure.security.keyvault.secrets.models.SecretProperties;
import com.azure.storage.blob.BlobServiceClient;
import com.azure.storage.blob.BlobServiceClientBuilder;
import com.azure.storage.blob.BlobContainerClient;

import java.util.Iterator;

public class BlobStorageFromKeyVault {
    public static void main(String[] args) {
        //  Key Vault URL (just replace with your actual vault name)
        String keyVaultUrl = "https://nsn-dev-ecm-kva-001.vault.azure.net/";

        // Use DefaultAzureCredential
        TokenCredential credential = new DefaultAzureCredentialBuilder().build();

        //  Access Key Vault
        SecretClient secretClient = new SecretClientBuilder()
                .vaultUrl(keyVaultUrl)
                .credential(credential)
                .buildClient();

        System.out.println("Connected to Key Vault: " + keyVaultUrl);
        System.out.println("Listing secrets...");

        try {
            // Use Iterator to loop over the secrets
            Iterator<SecretProperties> secretsIterator = secretClient.listPropertiesOfSecrets().iterator();
            while (secretsIterator.hasNext()) {
                SecretProperties secretProperty = secretsIterator.next();
                System.out.println("🔐 Secret name: " + secretProperty.getName());
            }
        } catch (Exception e) {
            System.err.println("❌ Failed to list secrets: " + e.getMessage());
            e.printStackTrace();
        }

        //  Get secrets (Account Name, Account Key, Container Name)
        String accountName = secretClient.getSecret("blob-storage-account-name").getValue();
        String accountKey = secretClient.getSecret("blob-storage-account-key").getValue();
        String containerName = secretClient.getSecret("blob-storage-container-name").getValue();

        // 📦 Build connection string
        String connectionString = String.format(
                "DefaultEndpointsProtocol=https;AccountName=%s;AccountKey=%s;EndpointSuffix=core.windows.net",
                accountName, accountKey
        );

        // ☁️ Connect to Blob Storage
        BlobServiceClient blobServiceClient = new BlobServiceClientBuilder()
                .connectionString(connectionString)
                .buildClient();

        BlobContainerClient containerClient = blobServiceClient.getBlobContainerClient(containerName);

        // 📃 List blobs in the container
        System.out.println("Blobs in container: " + containerName);
        containerClient.listBlobs().forEach(blobItem -> {
            System.out.println("- " + blobItem.getName());
        });
    }
}
