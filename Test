package com.nedbank.kafka.filemanage.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.http.HttpHost;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.impl.conn.DefaultProxyRoutePlanner;
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.*;

import java.net.Authenticator;
import java.net.PasswordAuthentication;

public class VaultClient {

    private static final String AUTH_URL = "https://vault-public-vault-75e984b5.bdecd756.z1.hashicorp.cloud:8200/v1/auth/userpass/login/espire_dev";
    private static final String SECRET_URL = "https://vault-public-vault-75e984b5.bdecd756.z1.hashicorp.cloud:8200/v1/Store_Dev/10099";
    private static final String NAMESPACE = "admin/espire";
    private static final String USER_PASSWORD = "Dev+Cred4#";

    private final RestTemplate restTemplate = new RestTemplate();
    //private final RestTemplate restTemplate = createRestTemplateWithProxy();
    private final ObjectMapper mapper = new ObjectMapper();

    public String getSecretFromVault() {
        try {
            // 1. Authenticate and get token
            HttpHeaders authHeaders = new HttpHeaders();
            authHeaders.setContentType(MediaType.APPLICATION_JSON);
            authHeaders.set("x-vault-namespace", NAMESPACE);

            String authBody = "{\"password\": \"" + USER_PASSWORD + "\"}";
            HttpEntity<String> authRequest = new HttpEntity<>(authBody, authHeaders);

            ResponseEntity<String> authResponse = restTemplate.postForEntity(AUTH_URL, authRequest, String.class);
            if (!authResponse.getStatusCode().is2xxSuccessful()) {
                throw new RuntimeException("Failed to authenticate with Vault");
            }

            JsonNode authJson = mapper.readTree(authResponse.getBody());
            String token = authJson.at("/auth/client_token").asText();

            // 2. Read secret using token
            HttpHeaders readHeaders = new HttpHeaders();
            readHeaders.set("x-vault-namespace", NAMESPACE);
            readHeaders.set("x-vault-token", token);

            HttpEntity<Void> readRequest = new HttpEntity<>(readHeaders);
            ResponseEntity<String> readResponse = restTemplate.exchange(SECRET_URL, HttpMethod.GET, readRequest, String.class);

            if (!readResponse.getStatusCode().is2xxSuccessful()) {
                throw new RuntimeException("Failed to read secret from Vault");
            }

            return readResponse.getBody();

        } catch (Exception e) {
            throw new RuntimeException("Error while accessing Vault: " + e.getMessage(), e);
        }
    }
    /*public RestTemplate createRestTemplateWithProxy() {
        HttpHost proxy = new HttpHost("webproxy.africa.nedcor.net", 9001);
        DefaultProxyRoutePlanner routePlanner = new DefaultProxyRoutePlanner(proxy);

        CloseableHttpClient httpClient = HttpClients.custom()
                .setRoutePlanner(routePlanner)
                .build();

        HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient);
        return new RestTemplate(factory);
    }*/

    public static void main(String[] args) {
        // Set proxy settings
        System.setProperty("http.proxyHost", "webproxy.africa.nedcor.net");
        System.setProperty("http.proxyPort", "9001");
        System.setProperty("https.proxyHost", "webproxy.africa.nedcor.net");
        System.setProperty("https.proxyPort", "9001");

        Authenticator.setDefault(new Authenticator() {
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication("CC437236", "34dYaB@jEh56".toCharArray());
            }
        });

        VaultClient vaultService = new VaultClient();
        String secret = vaultService.getSecretFromVault();
        System.out.println("Secret from Vault:\n" + secret);
    }
}
